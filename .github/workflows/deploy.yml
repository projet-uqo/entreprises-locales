# This is a basic workflow to help you get started with Actions

# D√©ploiement automatique du site web via GitHub Actions
name: D√©ploiement vers GitHub Pages

permissions:
  contents: write
  pull-requests: read

# üìÖ D√©clenchement du workflow
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ] # D√©clench√© √† chaque push sur la branche principale
    paths:
      - "approved/**"  # D√©clenche quand tu approuves une soumission
      - "!submissions/**" # Ignore les soumissions non approuv√©es
      - "!Informations sur les entreprises.xlsx" # Emp√™che les boucles

  pull_request:
    branches: [ "main" ] # Optionnel : d√©clenche sur les pull requests
    types: [opened, synchronize]

 # Permet de lancer manuellement depuis l'onglet Actions
  workflow_dispatch: 

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
# D√©finition du job principal
jobs:
  # This workflow contains a single job called "build"
  build:
    # üîê S√©curit√© : emp√™cher les PR externes et les boucles
    if: >
      github.actor != 'github-actions[bot]' &&
      (github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository)

    # The type of runner that the job will run on
    runs-on: ubuntu-latest # Utilise un environnement Linux pour ex√©cuter les √©tapes

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      # √âtape 1 : R√©cup√©ration du d√©p√¥t
      - name: Checkout d√©p√¥t
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      # √âtape 2 : Configuration de Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      #  √âtape 3 : Installation des d√©pendances
      - name: Installer les d√©pendances Python
        run: |
          pip install pandas folium openpyxl tqdm geopy

      # √âtape 4: Traiter les soumissions approuv√©s
      - name: Traiter les soumissions approuv√©es
        run: |
          python process_approved.py


      #  √âtape 5 : G√©n√©ration du sitemap et robots.txt (comment√©e pour l‚Äôinstant)
      - name: G√©n√©rer le site, sitemap et robots.txt
        run: |
          python generate_site.py
          python generate_sitemap.py

      # √âtape 6 : V√©rification que index.html existe
      - name: V√©rifier la pr√©sence de index.html
        run: |
          test -f site/index.html && echo "index.html pr√©sent" || (echo "index.html manquant" && exit 1)
     
      # √âtape 7 : V√©rification que sitemap.xml et robot.txt existent
      - name: V√©rifier la pr√©sence de sitemap.xml et robots.txt
        run: |
          test -f site/sitemap.xml && echo "‚úÖ sitemap.xml pr√©sent" || (echo "sitemap.xml manquant" && exit 1)
          test -f site/robots.txt && echo "‚úÖ robots.txt pr√©sent" || (echo "robots.txt manquant" && exit 1)     
      
      # √âtape 8 : Enregistrement et mise √† jour du fichier Excel
      - name: Commit & push updated Excel file
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add "Informations sur les entreprises.xlsx"
          git commit -m "Mise √† jour automatique du fichier Excel via GitHub Actions" || echo "Aucun changement √† committer"
          git push

      # √âtape 9 : D√©ploiement vers GitHub Pages
      - name: D√©ployer vers GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages



